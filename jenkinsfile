pipeline {
    agent { label 'slave1' }

    stages {
        stage('Copying the code') {
            steps {
                echo "Copying the code"
                git url: "https://github.com/addico786/django_app.git", branch: "master"
                echo "Code copied successfully"
            }
        }

        stage('Installing Docker') {
            steps {
                echo "Installing Docker"
                sh "curl -LO https://raw.githubusercontent.com/addico786/tools_download_scripts/master/docker.sh"
                sh "chmod +x docker.sh"
                sh "./docker.sh"
                echo "Docker installed successfully"
            }
        }

        stage('Building the code') {
            steps {
                echo "Building the code"
                sh "docker build -t my-app:latest ."
                echo "Code built successfully"
            }
        }

        stage('Pushing to Docker Hub') {
            steps {
                echo "Pushing the code to Docker Hub"
                withCredentials([usernamePassword(
                    credentialsId: "docker-hub-cred",
                    usernameVariable: "dockerhubuser",
                    passwordVariable: "dockerhubPass"
                )]) {
                    sh "docker login -u ${dockerhubuser} -p ${dockerhubPass}"
                    sh "docker image tag my-app:latest ${dockerhubuser}/my-app:latest"
                    sh "docker push ${dockerhubuser}/my-app:latest"
                    echo "Code pushed to Docker Hub successfully"
                }
            }
        }

        stage('Deploying the code on server') {
            steps {
                echo "Deploying the code on server"
                sh "docker run -d -p 8000:8000 my-app:latest"
                sh "docker ps"
                echo "Code deployed successfully"
            }
        }
    }
}
